<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <title>Chrono VTT - Debug</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
</head>
<body>
  <h2>Chrono VTT - Test</h2>

  Nom du cycliste :
  <input id="nameInput" type="text" placeholder="Votre nom" />
  <button id="startBtn">OK - Démarrer</button>
  <button id="stopBtn" disabled>Arrêter</button>

  <p id="status">En attente...</p>
  <h3 id="eventMsg"></h3>

  <pre id="log" style="height:200px; overflow:auto; background:#f6f6f6; padding:8px;"></pre>

<script>
let cycliste = "";

// anti-spam : un objet qui garde pour chaque segment s’il a déjà envoyé départ/arrivée
const antiSpam = {};

// Exemple waypoints avec 2 segments
const waypoints = {
  depart_seg1:  {lat: 43.2305551, lon: 3.0635999, rayon: 30},
  arrivee_seg1: {lat: 43.2303,    lon: 3.0642,    rayon: 30},

  depart_seg2:  {lat: 43.2310, lon: 3.0650, rayon: 30},
  arrivee_seg2: {lat: 43.2320, lon: 3.0670, rayon: 30}
};

const apiURL = "https://script.google.com/macros/s/TON_URL/exec";

// --------------------------
function logEvent(key, lat, lon) {
  // key = "depart_seg1" ou "arrivee_seg2"
  const [type, segment] = key.split('_'); // ex: type="depart", segment="seg1"

  // initialiser antiSpam si pas encore fait
  if (!antiSpam[segment]) {
    antiSpam[segment] = {depart:false, arrivee:false};
  }

  // si déjà envoyé on sort
  if (antiSpam[segment][type]) {
    console.log(`Événement ${type} déjà envoyé pour ${segment}`);
    return;
  }

  // on bloque l’événement pour éviter le spam
  antiSpam[segment][type] = true;

  let msg = "";
  if (type === "depart") msg = `🚴 Top départ ${segment}!`;
  if (type === "arrivee") msg = `🏁 Fin du segment ${segment}!`;
  document.getElementById("eventMsg").innerText = msg;

  const url = `${apiURL}?cycliste=${encodeURIComponent(cycliste)}&segment=${encodeURIComponent(segment)}&type=${encodeURIComponent(type)}&lat=${lat}&lon=${lon}`;

  fetch(url)
    .then(r => r.text())
    .then(txt => {
      console.log("Réponse:", txt);
      document.getElementById("status").innerText = txt;
    })
    .catch(err => {
      console.error("Erreur fetch", err);
      document.getElementById("status").innerText = "Erreur: " + err;
    });
}

// --------------------------
navigator.geolocation.watchPosition(pos => {
  const lat = pos.coords.latitude;
  const lon = pos.coords.longitude;
  document.getElementById("status").innerText = `GPS: ${lat}, ${lon}`;

  for (const [key, wp] of Object.entries(waypoints)) {
    const d = distance(lat, lon, wp.lat, wp.lon);
    if (d < wp.rayon) {
      logEvent(key, lat, lon);
    }
  }
}, err => {
  document.getElementById("status").innerText = "Erreur GPS: " + err.message;
}, {enableHighAccuracy: true});

// --------------------------
function distance(lat1, lon1, lat2, lon2) {
  const R = 6371e3;
  const φ1 = lat1 * Math.PI/180;
  const φ2 = lat2 * Math.PI/180;
  const Δφ = (lat2-lat1) * Math.PI/180;
  const Δλ = (lon2-lon1) * Math.PI/180;
  const a = Math.sin(Δφ/2) * Math.sin(Δφ/2) +
            Math.cos(φ1) * Math.cos(φ2) *
            Math.sin(Δλ/2) * Math.sin(Δλ/2);
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  return R * c;
}
</script>
</body>
</html>
