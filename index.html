<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Chrono VTT DIY</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="theme-color" content="#2b2b2b">
</head>
<body>
  <h2>Chrono VTT - Tracking Waypoints</h2>

  Nom du cycliste :
  <input id="nameInput" type="text" placeholder="Votre nom">
  <button onclick="startTracking()">OK</button>

  <p id="status">En attente du GPS‚Ä¶</p>
  <h3 id="eventMsg"></h3>

<script>
let cycliste = "";
let watchId = null;
let wakeLock = null;

// √©tat anti-spam pour chaque segment
let state = {}; // state[segment] = "none" | "depart" | "arrivee"

const segment = "Segment1";
const apiURL = "https://script.google.com/macros/s/AKfycbw9ApgkgmkJqEGgFuBGd7iRDy8ARfm3lLS8BXQH4QsLFW_dRjpUNZRxlY1_EdCGCGHptA/exec"; // <-- ton Apps Script
const waypoints = {
  depart:  {lat: 43.2305551, lon: 3.0635999, rayon: 15},
  arrivee: {lat: 43.2303,    lon: 3.0642,    rayon: 15}
};

// lance la g√©olocalisation et le wakeLock
function startTracking() {
  cycliste = document.getElementById("nameInput").value.trim();
  if (!cycliste) {
    alert("Merci de saisir votre nom");
    return;
  }
  localStorage.setItem("cycliste", cycliste);

  // initialise l‚Äô√©tat anti-spam
  state[segment] = "none";

  // d√©marrage du GPS
  if (watchId !== null) navigator.geolocation.clearWatch(watchId);
  watchId = navigator.geolocation.watchPosition(onPos, onError, {enableHighAccuracy:true});
  document.getElementById("status").innerText = "GPS d√©marr√©‚Ä¶";

  // tenter de garder l‚Äô√©cran allum√© (Android/Chrome)
  requestWakeLock();
}

// r√©cup√®re nom d√©j√† stock√©
window.onload = () => {
  const stored = localStorage.getItem("cycliste");
  if (stored) {
    cycliste = stored;
    document.getElementById("nameInput").value = cycliste;
  }
};

async function requestWakeLock() {
  try {
    if ('wakeLock' in navigator) {
      wakeLock = await navigator.wakeLock.request('screen');
      console.log('√âcran maintenu allum√©');
      wakeLock.addEventListener('release', () => {
        console.log('WakeLock lib√©r√©');
      });
    } else {
      console.log('WakeLock non support√© sur ce navigateur');
    }
  } catch (err) {
    console.error('WakeLock erreur:', err);
  }
}

function onPos(pos){
  const lat = pos.coords.latitude;
  const lon = pos.coords.longitude;
  document.getElementById("status").innerText = `GPS: ${lat.toFixed(6)}, ${lon.toFixed(6)}`;

  for (const [key, wp] of Object.entries(waypoints)) {
    const d = distance(lat, lon, wp.lat, wp.lon);
    if (d < wp.rayon) {
      logEvent(key, lat, lon);
    }
  }
}

function onError(err){
  document.getElementById("status").innerText = "Erreur GPS: " + err.message;
}

function distance(lat1, lon1, lat2, lon2) {
  const R = 6371e3;
  const œÜ1 = lat1 * Math.PI/180;
  const œÜ2 = lat2 * Math.PI/180;
  const ŒîœÜ = (lat2-lat1) * Math.PI/180;
  const ŒîŒª = (lon2-lon1) * Math.PI/180;
  const a = Math.sin(ŒîœÜ/2) * Math.sin(ŒîœÜ/2) +
            Math.cos(œÜ1) * Math.cos(œÜ2) *
            Math.sin(ŒîŒª/2) * Math.sin(ŒîŒª/2);
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  return R * c;
}

function logEvent(type, lat, lon) {
  // Anti-spam : ne renvoyer qu‚Äôune fois chaque √©tape
  if (!state[segment]) state[segment] = "none";
  if (type === "depart" && state[segment] === "depart") return;
  if (type === "arrivee" && state[segment] === "arrivee") return;

  state[segment] = type; // maj √©tat

  let msg = "";
  if (type === "depart") msg = "üö¥ Top d√©part !";
  if (type === "arrivee") msg = "üèÅ Fin du segment !";
  document.getElementById("eventMsg").innerText = msg;

  const url = `${apiURL}?cycliste=${encodeURIComponent(cycliste)}&segment=${encodeURIComponent(segment)}&type=${encodeURIComponent(type)}&lat=${lat}&lon=${lon}`;
  fetch(url)
    .then(r => r.text())
    .then(txt => {
      console.log("R√©ponse:", txt);
      document.getElementById("status").innerText = txt;
    })
    .catch(err => {
      console.error("Erreur fetch", err);
      document.getElementById("status").innerText = "Erreur: " + err;
    });
}
</script>
</body>
</html>
